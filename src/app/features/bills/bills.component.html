<div class="max-w-7xl mx-auto px-4 py-6">
  @if (!activeProfile()) {
    <app-empty-state
      [icon]="CreditCard"
      title="No Profile Selected"
      message="Select a profile to view your bills"
    />
  } @else {
    <!-- Header with Create Bill Button -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Bills & Statements</h1>
        <p class="text-slate-600 mt-1">Credit card bills auto-generated from your transactions</p>
      </div>
      <div class="flex items-center gap-2">
        @if (bulkSelectMode() && selectedBills().size > 0) {
          <button
            type="button"
            (click)="copySelectedBills()"
            [class]="batchCopied() ? 'btn btn-success' : 'btn btn-secondary'"
          >
            @if (batchCopied()) {
              <lucide-angular [img]="CheckCircle2" [size]="16" />
              <span>Copied {{ selectedBills().size }}!</span>
            } @else {
              <lucide-angular [img]="Copy" [size]="16" />
              <span>Copy {{ selectedBills().size }} Selected</span>
            }
          </button>
        }
        @if (bulkSelectMode()) {
          <button
            type="button"
            (click)="setBulkSelectMode(false)"
            class="btn btn-ghost"
          >
            Cancel Select
          </button>
        } @else {
          <button
            type="button"
            (click)="setBulkSelectMode(true)"
            class="btn btn-secondary"
          >
            <lucide-angular [img]="Copy" [size]="16" />
            Bulk Copy
          </button>
        }
        <button
          type="button"
          (click)="openBillFormForCreate()"
          class="btn btn-primary"
        >
          <lucide-angular [img]="Plus" [size]="20" />
          <span>Create Bill</span>
        </button>
      </div>
    </div>

    <!-- Summary Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <app-metric-card
        [icon]="AlertCircle"
        label="Total Due"
        [value]="formatCurrency(summary().totalDue)"
        variant="warning"
      />

      <app-metric-card
        [icon]="FileText"
        label="Unpaid Bills"
        [value]="summary().unpaidCount.toString()"
        variant="danger"
      />

      <app-metric-card
        [icon]="CheckCircle"
        label="Paid Bills"
        [value]="summary().paidCount.toString()"
        variant="success"
      />

      <app-metric-card
        [icon]="DollarSign"
        label="Total Paid"
        [value]="formatCurrency(summary().totalPaid)"
        variant="info"
      />
    </div>

    <!-- Bills List -->
    <div class="space-y-4">
      @if (billsWithDetails().length === 0) {
        <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-6">
          <app-empty-state
            [icon]="CreditCard"
            title="No credit cards"
            message="Add credit cards in the Manage page to start tracking your bills"
          />
        </div>
      } @else {
        @if (bulkSelectMode()) {
          <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-3 mb-4">
            <div class="flex items-center gap-3">
              <input
                type="checkbox"
                [checked]="allBillsSelected"
                (change)="toggleAllBills()"
                class="w-4 h-4 text-blue-600"
                aria-label="Select all bills"
              />
              <span class="text-sm font-medium text-slate-700">
                Select All ({{ selectedBills().size }} selected)
              </span>
            </div>
          </div>
        }
        @for (bill of billsWithDetails(); track bill.cardId) {
          <div
            class="bill-card bg-white rounded-lg border-2 shadow-sm overflow-hidden"
            [style.border-color]="bill.color"
            [class.bg-green-50]="bill.isPaid"
          >
            <!-- Bill Header -->
            <div class="p-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3 flex-1">
                  @if (bulkSelectMode()) {
                    <input
                      type="checkbox"
                      [checked]="isBillSelected(bill.cardId)"
                      (change)="toggleBillSelection(bill.cardId)"
                      class="w-4 h-4 text-blue-600"
                      [attr.aria-label]="'Select ' + bill.bankName + ' ' + bill.cardName"
                    />
                  }
                  <div
                    class="w-1 h-16 rounded-full"
                    [style.background-color]="bill.color"
                  ></div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2">
                      <h3 class="text-lg font-semibold text-slate-900">{{ bill.bankName }} {{ bill.cardName }}</h3>
                      @if (bill.isPaid) {
                        <span
                          class="px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700 rounded-full"
                        >
                          Paid
                        </span>
                      } @else {
                        <span
                          class="px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-full"
                        >
                          Unpaid
                        </span>
                      }
                    </div>
                    <div class="flex items-center gap-4 mt-1">
                      <div class="flex items-center gap-1 text-sm text-slate-600">
                        <lucide-angular [img]="Calendar" [size]="14" />
                        <span>Due {{ bill.dueDate | date : 'MMM d, yyyy' }}</span>
                      </div>
                      <div class="flex items-center gap-1 text-sm text-slate-600">
                        <lucide-angular [img]="FileText" [size]="14" />
                        <span>{{ bill.transactions.length }} transaction(s)</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="flex items-center gap-4">
                  <div class="text-right">
                    <div class="text-2xl font-bold text-slate-900">
                      {{ formatCurrency(bill.amount) }}
                    </div>
                    @if (bill.isPaid) {
                      <div class="text-xs text-green-600">
                        Paid: {{ formatCurrency(bill.paidAmount) }}
                      </div>
                    } @else if (bill.paidAmount > 0) {
                      <div class="text-xs text-blue-600">
                        Paid: {{ formatCurrency(bill.paidAmount) }}
                      </div>
                      <div class="text-xs font-semibold text-orange-600 mt-0.5">
                        Remaining: {{ formatCurrency(bill.amount - bill.paidAmount) }}
                      </div>
                    } @else if (!bill.statement) {
                      <div class="text-xs text-slate-500">No statement yet</div>
                    }
                  </div>

                  <div class="flex gap-2">
                    <button
                      type="button"
                      (click)="copyBillInfo(bill)"
                      [disabled]="copiedBillId() === bill.cardId"
                      class="px-3 py-1.5 text-sm font-medium border border-blue-300 text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100 transition-colors flex items-center gap-1"
                      [attr.aria-label]="'Copy info for ' + bill.bankName + ' ' + bill.cardName"
                      title="Copy card info"
                    >
                      @if (copiedBillId() === bill.cardId) {
                        <lucide-angular [img]="CheckCircle2" [size]="16" />
                        <span>Copied!</span>
                      } @else {
                        <lucide-angular [img]="Copy" [size]="16" />
                        <span>Copy</span>
                      }
                    </button>
                    @if (bill.statement) {
                      <button
                        type="button"
                        (click)="openBillFormForEdit(bill)"
                        class="btn btn-secondary"
                        title="Edit bill details"
                      >
                        Edit
                      </button>
                    }
                    @if (!bill.isPaid && bill.statement) {
                      <button
                        type="button"
                        (click)="openPaymentModal(bill)"
                        class="btn btn-green"
                      >
                        Pay Bill
                      </button>
                    } @else if (bill.isPaid && bill.statement) {
                      <button
                        type="button"
                        (click)="markAsUnpaid(bill)"
                        class="btn btn-ghost"
                      >
                        Mark Unpaid
                      </button>
                    }
                    @if (bill.transactions.length > 0 || (bill.statement?.payments && bill.statement!.payments!.length > 0)) {
                      <button
                        type="button"
                        (click)="toggleExpand(bill)"
                        class="btn btn-ghost"
                      >
                        <span>{{ bill.isExpanded ? 'Hide' : 'Show' }} Details</span>
                        <lucide-angular [img]="bill.isExpanded ? ChevronUp : ChevronDown" [size]="16" />
                      </button>
                    }
                  </div>
                </div>
              </div>
            </div>

            <!-- Transactions List (Expandable) -->
            @if (bill.isExpanded) {
              <div class="border-t border-slate-200 bg-slate-50">
                <div class="p-4">
                  <!-- Payment History -->
                  @if (bill.statement?.payments && bill.statement!.payments!.length > 0) {
                    <div class="mb-4">
                      <h4 class="text-sm font-semibold text-slate-700 mb-2">Payment History</h4>
                      <div class="bg-white rounded-md border border-slate-200">
                        @for (payment of bill.statement!.payments; track $index) {
                          <div class="transaction-item group">
                            <div class="flex-1">
                              <div class="font-medium text-slate-900">Payment</div>
                              <div class="text-xs text-slate-500 mt-0.5">
                                {{ formatDate(payment.date) }}
                              </div>
                            </div>
                            <div class="flex items-center gap-4">
                              <div class="font-semibold text-green-600">
                                +{{ formatCurrency(payment.amount) }}
                              </div>
                              <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button
                                  type="button"
                                  (click)="openPaymentModal(bill, payment, $index)"
                                  class="p-1 text-slate-400 hover:text-blue-600 rounded hover:bg-blue-50"
                                  title="Edit payment"
                                >
                                  <lucide-angular [img]="Edit" [size]="14" />
                                </button>
                                <button
                                  type="button"
                                  (click)="deletePayment(bill, $index)"
                                  class="p-1 text-slate-400 hover:text-red-600 rounded hover:bg-red-50"
                                  title="Delete payment"
                                >
                                  <lucide-angular [img]="Trash2" [size]="14" />
                                </button>
                              </div>
                            </div>
                          </div>
                        }
                      </div>
                    </div>
                  }
                  
                  @if (bill.transactions.length > 0) {
                    <h4 class="text-sm font-semibold text-slate-700 mb-2">Linked Transactions</h4>
                    <div class="bg-white rounded-md border border-slate-200">
                      @for (transaction of bill.transactions; track transaction.id) {
                        <div class="transaction-item">
                          <div class="flex-1">
                            <div class="font-medium text-slate-900">{{ transaction.description }}</div>
                            <div class="text-xs text-slate-500 mt-0.5">
                              {{ formatDate(transaction.date) }}
                              @if (transaction.notes) {
                                â€¢ {{ transaction.notes }}
                              }
                            </div>
                          </div>
                          <div class="font-semibold text-red-600">
                            -{{ formatCurrency(transaction.amount) }}
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
      }
    </div>

    <!-- Help Text -->
    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start gap-3">
        <lucide-angular [img]="FileText" [size]="20" class="text-blue-600 mt-0.5" />
        <div>
          <h4 class="font-semibold text-blue-900 mb-1">Smart Bill Generation</h4>
          <p class="text-sm text-blue-800">
            Bills are automatically generated from your credit card transactions. When you add a transaction with a
            credit card payment method, it's intelligently linked to the correct monthly statement based on the card's
            cutoff date. Click "Show Transactions" to see the breakdown.
          </p>
        </div>
      </div>
    </div>
  }

  <!-- Payment Modal -->
  @if (paymentModal().isOpen) {
    <div class="payment-modal">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-900">
            {{ paymentModal().editingIndex !== null ? 'Edit Payment' : 'Record Payment' }}
          </h3>
          <button
            type="button"
            (click)="closePaymentModal()"
            class="text-slate-400 hover:text-slate-600"
          >
            <lucide-angular [img]="X" [size]="20" />
          </button>
        </div>

        <div class="mb-4">
          <div class="text-sm text-slate-600 mb-2">Card</div>
          <div class="font-medium text-slate-900">{{ paymentModal().cardName }}</div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">Amount Paid</label>
          <input
            type="number"
            [(ngModel)]="paymentModalState().amount"
            placeholder="0.00"
            step="0.01"
            min="0"
            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">Payment Date</label>
          <input
            type="date"
            [(ngModel)]="paymentModalState().date"
            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div class="flex gap-2">
          <button
            type="button"
            (click)="recordPayment()"
            class="btn btn-green flex-1"
          >
            {{ paymentModal().editingIndex !== null ? 'Update Payment' : 'Record Payment' }}
          </button>
          <button
            type="button"
            (click)="closePaymentModal()"
            class="btn btn-ghost"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Bill Form Modal (Create/Edit) -->
  @if (billFormState().isOpen) {
    <div class="payment-modal">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-900">
            {{ billFormState().isEditing ? 'Edit Bill' : 'Create Manual Bill' }}
          </h3>
          <button
            type="button"
            (click)="closeBillForm()"
            class="text-slate-400 hover:text-slate-600"
          >
            <lucide-angular [img]="X" [size]="20" />
          </button>
        </div>

        <p class="text-sm text-slate-600 mb-4">
          Create a bill manually when you don't have time to enter individual transactions. This is useful when you
          receive a statement and just want to track the total amount.
        </p>

        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">Credit Card</label>
          <select
            [(ngModel)]="billFormState().cardId"
            (ngModelChange)="updateDueDateBasedOnCard(billFormState().cardId)"
            [disabled]="billFormState().isEditing"
            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-slate-100"
          >
            <option value="">Select a card...</option>
            @for (card of availableCards; track card.id) {
              <option [value]="card.id">{{ card.bankName }} {{ card.cardName }}</option>
            }
          </select>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">Bill Amount</label>
          <input
            type="number"
            [(ngModel)]="billFormState().amount"
            placeholder="0.00"
            step="0.01"
            min="0"
            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Due Date (Optional)</label>
            <input
              type="date"
              [(ngModel)]="billFormState().dueDate"
              class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <p class="text-xs text-slate-500 mt-1">Defaults to the card's due day if not specified</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-2">Cut-off Day (Optional)</label>
            <input
              type="number"
              [(ngModel)]="billFormState().cutoffDay"
              placeholder="e.g. 10"
              min="1"
              max="31"
              class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <p class="text-xs text-slate-500 mt-1">Defaults to the card's cut-off day if not specified</p>
          </div>
        </div>

        <div class="mb-4">
          <label class="block text-sm font-medium text-slate-700 mb-2">Notes (Optional)</label>
          <textarea
            [(ngModel)]="billFormState().notes"
            rows="3"
            placeholder="Add any notes about this bill..."
            class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
          ></textarea>
        </div>

        <div class="flex gap-2">
          <button
            type="button"
            (click)="saveBill()"
            class="btn btn-primary flex-1"
          >
            {{ billFormState().isEditing ? 'Update Bill' : 'Create Bill' }}
          </button>
          <button
            type="button"
            (click)="closeBillForm()"
            class="btn btn-ghost"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  }
</div>
