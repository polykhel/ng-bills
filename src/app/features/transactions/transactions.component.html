<div class="max-w-7xl mx-auto px-4 py-6">
  @if (!activeProfile() && (!multiProfileMode() || selectedProfileIds().length === 0)) {
    <app-empty-state
      [icon]="FileText"
      title="No Profile Selected"
      message="Select a profile to view your transactions"
    />
  } @else {
    <!-- Header with Add Button -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Transactions</h1>
        <p class="text-slate-600 mt-1">Track your income and expenses</p>
      </div>
      <div class="flex items-center gap-3">
        <app-quick-action-button
          [icon]="Building2"
          [label]="showBankBalanceManagement ? 'Hide Bank Balance' : 'Manage Bank Balance'"
          variant="secondary"
          (clicked)="showBankBalanceManagement = !showBankBalanceManagement"
        />
        <app-quick-action-button
          [icon]="Plus"
          label="Add Transaction"
          [variant]="showForm() ? 'secondary' : 'primary'"
          (clicked)="onAddTransaction()"
        />
      </div>
    </div>

    <!-- Bank Balance Management -->
    @if (showBankBalanceManagement) {
      <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-6 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-slate-900">Bank Accounts & Balances</h2>
          <button
            type="button"
            (click)="onAddBankAccount()"
            class="px-3 py-1.5 text-sm font-medium text-blue-600 bg-blue-50 border border-blue-200 rounded-md hover:bg-blue-100 transition-colors"
          >
            + Add Bank Account
          </button>
        </div>
        
        @if (bankAccounts().length === 0) {
          <p class="text-slate-500 text-sm">No bank accounts yet. Add one to start tracking balances.</p>
        } @else {
          <div class="space-y-4">
            @for (account of bankAccounts(); track account.id) {
              <div class="p-4 border border-slate-200 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex items-center gap-3">
                    <div class="w-4 h-4 rounded-full" [style.background-color]="account.color"></div>
                    <div>
                      <h3 class="font-semibold text-slate-900">{{ account.bankName }}</h3>
                      <p class="text-xs text-slate-500">{{ account.accountType }} @if (account.accountNumber) { ‚Ä¢ {{ account.accountNumber }} }</p>
                    </div>
                  </div>
                  <div class="flex gap-2">
                    <button
                      type="button"
                      (click)="onEditBankAccount(account.id)"
                      class="text-blue-600 hover:text-blue-700 text-sm"
                    >
                      Edit
                    </button>
                    <button
                      type="button"
                      (click)="bankAccountService.deleteBankAccount(account.id)"
                      class="text-red-600 hover:text-red-700 text-sm"
                    >
                      Delete
                    </button>
                  </div>
                </div>
                <div class="mt-3">
                  <label class="block text-xs font-medium text-slate-700 mb-1">Current Balance</label>
                  <div class="flex items-center gap-2">
                    <span class="text-slate-600">‚Ç±</span>
                    <input
                      type="number"
                      [value]="getBankBalanceForAccount(account)"
                      (blur)="onUpdateBankBalance(account.id, $any($event.target).value)"
                      class="flex-1 px-3 py-2 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      step="0.01"
                      placeholder="0.00"
                    />
                  </div>
                </div>
              </div>
            }
          </div>
          
          <!-- Total Balance (Read-only) -->
          <div class="mt-6 pt-6 border-t border-slate-300">
            <div class="flex items-center justify-between">
              <div>
                <label class="block text-sm font-semibold text-slate-900 mb-1">Total Balance</label>
                <p class="text-xs text-slate-500">Sum of all accounts (calculated automatically)</p>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-slate-600">‚Ç±</span>
                <input
                  type="text"
                  [value]="getTotalBankBalance().toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })"
                  readonly
                  class="px-3 py-2 border border-slate-300 rounded-md text-sm bg-slate-50 text-slate-700 font-semibold cursor-not-allowed"
                  style="min-width: 150px; text-align: right;"
                />
              </div>
            </div>
          </div>
        }
      </div>
    }

    <!-- Add Transaction Form -->
    @if (showForm()) {
      <div class="transaction-form">
        <h3 class="font-semibold text-slate-900 mb-4">{{ editingTransactionId() ? 'Edit Transaction' : 'New Transaction' }}</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Type *</label>
            <select [(ngModel)]="formData.type" (ngModelChange)="onTransactionTypeChange($event)">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
          <div class="form-group">
            <label>Amount *</label>
            <input 
              type="number" 
              [(ngModel)]="formData.amount" 
              placeholder="0.00" 
              step="0.01" 
              min="0"
              [disabled]="isRecurringTransaction() && recurringType() === 'installment'"
            />
            @if (isRecurringTransaction() && recurringType() === 'installment') {
              <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                Amount will be set to monthly amortization
              </small>
            }
          </div>
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="formData.date" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Description *</label>
            <input type="text" [(ngModel)]="formData.description" placeholder="e.g., Lunch at restaurant" />
          </div>
          <div class="form-group">
            <label>Category</label>
            <select [(ngModel)]="formData.categoryId">
              <option value="uncategorized">Uncategorized</option>
              @for (category of categories(); track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select [(ngModel)]="formData.paymentMethod">
              @if (formData.type === 'income') {
                <option value="cash">Cash</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="bank_to_bank">Bank to Bank Transfer</option>
                <option value="other">Other</option>
              } @else {
                <option value="cash">Cash</option>
                <option value="card">Credit Card</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="bank_to_bank">Bank to Bank Transfer</option>
                <option value="other">Other</option>
              }
            </select>
          </div>
        </div>

        <div class="form-row">
          @if (formData.paymentMethod === 'card') {
            <div class="form-group">
              <label>Card</label>
              <select 
                [(ngModel)]="formData.cardId"
                (ngModelChange)="onCardChangeForInstallment()"
              >
                <option value="">Select a card...</option>
                @for (card of cards(); track card.id) {
                  <option [value]="card.id">{{ card.bankName }} {{ card.cardName }}</option>
                }
              </select>
              @if (isRecurringTransaction() && recurringType() === 'installment' && formData.cardId) {
                <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                  Installment will use this card's due date ({{ getCardDueDate(formData.cardId) | date:'MMM d' }})
                </small>
              }
            </div>
          }
          @if (formData.paymentMethod === 'bank_transfer' && formData.type === 'expense') {
            <div class="form-group">
              <label>Bank Account</label>
              <select [(ngModel)]="formData.bankId">
                <option value="">Select a bank account...</option>
                @for (account of bankAccounts(); track account.id) {
                  <option [value]="account.id">{{ account.bankName }}</option>
                }
              </select>
            </div>
          }
          @if (formData.paymentMethod === 'bank_transfer' && formData.type === 'income') {
            <div class="form-group">
              <label>Bank Account *</label>
              <select [(ngModel)]="formData.bankId" required>
                <option value="">Select account that received the money...</option>
                @for (account of bankAccounts(); track account.id) {
                  <option [value]="account.id">{{ account.bankName }}</option>
                }
              </select>
              <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                Account where the income was deposited (from external source)
              </small>
            </div>
          }
          @if (formData.paymentMethod === 'bank_to_bank') {
            <div class="form-group">
              <label>From Bank Account *</label>
              <select [(ngModel)]="formData.fromBankId" required>
                <option value="">Select source account...</option>
                @for (account of bankAccounts(); track account.id) {
                  <option [value]="account.id">{{ account.bankName }}</option>
                }
              </select>
              <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                Your account that sent the money
              </small>
            </div>
          }
          @if (formData.paymentMethod === 'bank_to_bank') {
            <div class="form-group">
              <label>To Bank Account *</label>
              <select [(ngModel)]="formData.toBankId" required>
                <option value="">Select destination account...</option>
                @for (account of bankAccounts(); track account.id) {
                  <option [value]="account.id">{{ account.bankName }}</option>
                }
              </select>
              <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                Your account that received the money
              </small>
            </div>
          }
          @if (formData.paymentMethod === 'bank_to_bank') {
            <div class="form-group">
              <label>Transfer Fee (optional)</label>
              <input type="number" [(ngModel)]="formData.transferFee" placeholder="0.00" step="0.01" min="0" />
              <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                Fee charged for transferring between your accounts
              </small>
            </div>
          }
          @if (formData.paymentMethod === 'card') {
            <div class="form-group" style="display: flex; align-items: flex-end; gap: 8px;">
              <label style="flex: 0 0 auto; margin-bottom: 0; display: flex; align-items: center; gap: 4px;">
                <input type="checkbox" [(ngModel)]="formData.paidByOther" />
                <span>Other person paid</span>
              </label>
            </div>
          }
        </div>

        @if (formData.paidByOther) {
          <div class="form-row">
            <div class="form-group">
              <label>Who paid? (Select Profile)</label>
              <select [(ngModel)]="formData.paidByOtherProfileId">
                <option value="">-- Manual Entry --</option>
                @for (prof of profileService.profiles(); track prof.id) {
                  @if (prof.id !== activeProfile()?.id) {
                    <option [value]="prof.id">{{ prof.name }}</option>
                  }
                }
              </select>
            </div>
            @if (!formData.paidByOtherProfileId) {
              <div class="form-group">
                <label>Or enter name</label>
                <input type="text" [(ngModel)]="formData.paidByOtherName" placeholder="e.g., John, Mom" />
              </div>
            }
          </div>
        }

        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="formData.notes" placeholder="Optional notes..." rows="2"></textarea>
        </div>

        <!-- Debt Obligation Section (Income only) -->
        @if (formData.type === 'income') {
          <div class="border-t border-slate-200 pt-4 mt-4">
            <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
              <input 
                type="checkbox" 
                id="hasDebtObligation"
                [(ngModel)]="formData.hasDebtObligation"
              />
              <label for="hasDebtObligation" style="margin-bottom: 0; font-weight: 600; cursor: pointer;">
                This income has a debt that must be paid back
              </label>
            </div>

            @if (formData.hasDebtObligation) {
              <div class="space-y-4" style="background: rgb(249, 250, 251); padding: 16px; border-radius: 8px;">
                <div class="form-row">
                  <div class="form-group">
                    <label>Debt Amount *</label>
                    <input 
                      type="number" 
                      [(ngModel)]="formData.debtAmount" 
                      placeholder="0.00" 
                      step="0.01" 
                      min="0.01"
                    />
                    <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                      Amount that needs to be paid back
                    </small>
                  </div>
                  <div class="form-group">
                    <label>Debt Due Date *</label>
                    <input 
                      type="date" 
                      [(ngModel)]="formData.debtDueDate"
                    />
                    <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                      When the debt must be paid
                    </small>
                  </div>
                </div>
                @if (editingTransactionId() && formData.debtPaid) {
                  <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                      <input 
                        type="checkbox" 
                        [(ngModel)]="formData.debtPaid"
                        disabled
                      />
                      <span>Debt has been paid</span>
                    </label>
                    @if (formData.debtPaidDate) {
                      <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                        Paid on: {{ formatDate(formData.debtPaidDate) }}
                      </small>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Recurring Transaction Section -->
        <div class="border-t border-slate-200 pt-4 mt-4">
          <div class="form-group" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
            <input 
              type="checkbox" 
              id="isRecurring"
              [checked]="isRecurringTransaction()"
              (change)="isRecurringTransaction.set($any($event.target).checked)"
            />
            <label for="isRecurring" style="margin-bottom: 0; font-weight: 600; cursor: pointer;">
              This is a recurring transaction
            </label>
          </div>

          @if (isRecurringTransaction()) {
            <div class="space-y-4" style="background: rgb(249, 250, 251); padding: 16px; border-radius: 8px;">
              <!-- Recurring Type Selector -->
              <div class="form-group">
                <label>Recurring Type *</label>
                <select 
                  [ngModel]="recurringType()" 
                  (ngModelChange)="onRecurringTypeChange($event)"
                  [ngModelOptions]="{standalone: true}"
                >
                  <option value="subscription">Subscription/Bill (e.g., Electricity, Water, Internet)</option>
                  <option value="installment">Installment (Fixed terms with total amount)</option>
                  <option value="custom">Custom Recurring</option>
                </select>
                <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                  @if (recurringType() === 'subscription') {
                    For ongoing monthly bills that repeat indefinitely
                  } @else if (recurringType() === 'installment') {
                    For purchases with fixed number of payments (e.g., 12-month installment plan)
                  } @else {
                    For custom recurring transactions
                  }
                </small>
              </div>

              <!-- Subscription/Custom Fields -->
              @if (recurringType() === 'subscription' || recurringType() === 'custom') {
                <div class="form-row">
                  <div class="form-group">
                    <label>Frequency *</label>
                    <select [(ngModel)]="recurringFormData.frequency">
                      <option value="monthly">Monthly</option>
                      <option value="weekly">Weekly</option>
                      <option value="biweekly">Bi-weekly</option>
                      <option value="quarterly">Quarterly</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Next Payment Date *</label>
                    <input 
                      type="date" 
                      [(ngModel)]="recurringFormData.nextDate"
                    />
                    <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                      When is the next occurrence of this transaction?
                    </small>
                  </div>
                </div>
              }

              <!-- Installment Fields -->
              @if (recurringType() === 'installment') {
                <div class="form-row">
                  <div class="form-group">
                    <label>Total Principal Amount *</label>
                    <input 
                      type="number" 
                      [(ngModel)]="recurringFormData.totalPrincipal" 
                      placeholder="0.00" 
                      step="0.01" 
                      min="0.01"
                    />
                  </div>
                  <div class="form-group">
                    <label>Total Terms (Months) *</label>
                    <input 
                      type="number" 
                      [(ngModel)]="recurringFormData.totalTerms" 
                      placeholder="12, 24, 36" 
                      min="1"
                    />
                  </div>
                  <div class="form-group">
                    <label>Monthly Amortization (Optional)</label>
                    <input 
                      type="number" 
                      [(ngModel)]="recurringFormData.monthlyAmortization" 
                      placeholder="Auto-calculated if blank" 
                      step="0.01" 
                      min="0"
                    />
                    <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                      Leave blank to auto-calculate (Principal √∑ Terms)
                    </small>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>Interest Rate (Optional)</label>
                    <input 
                      type="number" 
                      [(ngModel)]="recurringFormData.interestRate" 
                      placeholder="0.00" 
                      step="0.01" 
                      min="0"
                    />
                    <small style="color: rgb(100, 116, 139); font-size: 11px; margin-top: 4px; display: block;">
                      Annual percentage rate (0 for 0% financing)
                    </small>
                  </div>
                </div>

                <div style="border-top: 1px solid rgb(226, 232, 240); padding-top: 16px; margin-top: 16px;">
                  <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: rgb(15, 23, 42);">
                    How to Determine Start Date?
                  </h4>
                  <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button
                      type="button"
                      (click)="setInstallmentMode('date')"
                      [ngClass]="installmentMode() === 'date' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'"
                      style="flex: 1; padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                    >
                      Set Start Date
                    </button>
                    <button
                      type="button"
                      (click)="setInstallmentMode('term')"
                      [ngClass]="installmentMode() === 'term' ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'"
                      style="flex: 1; padding: 8px 16px; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
                    >
                      Set Current Term
                    </button>
                  </div>

                  @if (installmentMode() === 'date') {
                    <div class="form-group">
                      <label>Start Date (First Payment Month) *</label>
                      <input 
                        type="date" 
                        [(ngModel)]="recurringFormData.startDate"
                        (ngModelChange)="onStartDateChange()"
                      />
                      @if (recurringFormData.startDate && calculateCurrentTermFromStartDate()) {
                        <div style="margin-top: 8px; padding: 12px; background: rgb(239, 246, 255); border: 1px solid rgb(191, 219, 254); border-radius: 6px;">
                          <p style="font-size: 12px; color: rgb(30, 64, 175); margin: 0;">
                            <span style="font-weight: 600;">Calculated Current Term:</span>
                            {{ calculateCurrentTermFromStartDate() }} / {{ recurringFormData.totalTerms || '?' }}
                            <span style="color: rgb(148, 163, 184);"> (for {{ getFormattedViewDate() }})</span>
                          </p>
                        </div>
                      }
                    </div>
                  }

                  @if (installmentMode() === 'term') {
                    <div class="form-group">
                      <label>Current Term (Month # for {{ getFormattedViewDate() }}) *</label>
                      <input 
                        type="number" 
                        [(ngModel)]="recurringFormData.currentTerm" 
                        [max]="recurringFormData.totalTerms || 12"
                        min="1"
                        placeholder="e.g. 5"
                      />
                      @if (recurringFormData.currentTerm && recurringFormData.currentTerm > 0 && recurringFormData.currentTerm <= (recurringFormData.totalTerms || 12)) {
                        <div style="margin-top: 8px; padding: 12px; background: rgb(239, 246, 255); border: 1px solid rgb(191, 219, 254); border-radius: 6px;">
                          <p style="font-size: 12px; color: rgb(30, 64, 175); margin: 0;">
                            <span style="font-weight: 600;">Calculated Start Date:</span>
                            {{ getCalculatedStartDate() }}
                            <span style="color: rgb(148, 163, 184);"> (Term 1)</span>
                          </p>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" (click)="onSubmitTransaction()">Save Transaction</button>
          <button class="btn btn-secondary" (click)="onAddTransaction()">Cancel</button>
        </div>
      </div>
    }

    <!-- Summary Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <app-metric-card
        [icon]="TrendingUp"
        label="Total Income"
        [value]="'‚Ç±' + summary().totalIncome.toLocaleString()"
        variant="success"
      />

      <app-metric-card
        [icon]="TrendingDown"
        label="Total Expenses"
        [value]="'‚Ç±' + summary().totalExpenses.toLocaleString()"
        variant="danger"
      />

      <app-metric-card
        [icon]="Wallet"
        label="Net Change"
        [value]="'‚Ç±' + summary().netChange.toLocaleString()"
        [variant]="summary().netChange >= 0 ? 'success' : 'danger'"
      />

      <app-metric-card
        [icon]="FileText"
        label="Transactions"
        [value]="summary().transactionCount.toString()"
        variant="info"
      />
    </div>

    <!-- Search and Sort Bar -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4 mb-6">
      <div class="flex items-center gap-4 mb-4">
        <div class="flex-1 relative">
          <lucide-angular [img]="Search" [size]="18" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" />
          <input
            type="text"
            [value]="searchQuery()"
            (input)="searchQuery.set($any($event.target).value)"
            placeholder="Search transactions by description, notes, or amount..."
            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium text-slate-700">Sort by:</span>
          <div class="flex items-center gap-1">
            <button
              type="button"
              (click)="onSortChange('date')"
              [ngClass]="sortField() === 'date' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-700 border-slate-300'"
              class="px-3 py-1.5 text-sm border rounded-md transition-colors hover:bg-slate-100 flex items-center gap-1"
            >
              Date
              @if (sortField() === 'date') {
                <lucide-angular [img]="sortDirection() === 'asc' ? ArrowUp : ArrowDown" [size]="14" />
              }
            </button>
            <button
              type="button"
              (click)="onSortChange('amount')"
              [ngClass]="sortField() === 'amount' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-700 border-slate-300'"
              class="px-3 py-1.5 text-sm border rounded-md transition-colors hover:bg-slate-100 flex items-center gap-1"
            >
              Amount
              @if (sortField() === 'amount') {
                <lucide-angular [img]="sortDirection() === 'asc' ? ArrowUp : ArrowDown" [size]="14" />
              }
            </button>
            <button
              type="button"
              (click)="onSortChange('description')"
              [ngClass]="sortField() === 'description' ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-700 border-slate-300'"
              class="px-3 py-1.5 text-sm border rounded-md transition-colors hover:bg-slate-100 flex items-center gap-1"
            >
              Description
              @if (sortField() === 'description') {
                <lucide-angular [img]="sortDirection() === 'asc' ? ArrowUp : ArrowDown" [size]="14" />
              }
            </button>
          </div>
        </div>
      </div>
      
      <!-- Filters Bar -->
      <div class="flex items-center justify-between gap-4 border-t border-slate-200 pt-4">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-sm font-medium text-slate-700">Filters:</span>
          <button
            type="button"
            (click)="showAllTransactions.set(!showAllTransactions())"
            [ngClass]="showAllTransactions() ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-700 border-slate-300'"
            class="px-3 py-1.5 text-sm border rounded-md transition-colors hover:bg-slate-100"
          >
            {{ showAllTransactions() ? 'All Time' : 'Current Month' }}
          </button>
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-slate-700 whitespace-nowrap">Date Range:</label>
            <input
              type="date"
              [value]="filterFromDate()"
              (input)="filterFromDate.set($any($event.target).value)"
              [min]="getMinDate()"
              [max]="filterToDate() || getMaxDate()"
              class="px-3 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="From"
            />
            <span class="text-slate-500 text-sm">to</span>
            <input
              type="date"
              [value]="filterToDate()"
              (input)="filterToDate.set($any($event.target).value)"
              [min]="filterFromDate() || getMinDate()"
              [max]="getMaxDate()"
              class="px-3 py-1.5 text-sm border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              placeholder="To"
            />
            @if (filterFromDate() || filterToDate()) {
              <button
                type="button"
                (click)="filterFromDate.set(''); filterToDate.set('')"
                class="text-slate-400 hover:text-slate-600 transition-colors"
                title="Clear date range"
              >
                <lucide-angular [img]="X" [size]="14" />
              </button>
            }
          </div>
          <button
            type="button"
            (click)="hidePaidTransactions.set(!hidePaidTransactions())"
            [ngClass]="hidePaidTransactions() ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-slate-50 text-slate-700 border-slate-300'"
            class="px-3 py-1.5 text-sm border rounded-md transition-colors hover:bg-slate-100"
          >
            {{ hidePaidTransactions() ? 'Hide Paid' : 'Show All' }}
          </button>
          <select [ngModel]="filterType()" (ngModelChange)="filterType.set($event)" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option value="all">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <select [ngModel]="filterPaymentMethod()" (ngModelChange)="filterPaymentMethod.set($event)" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option value="all">All Methods</option>
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="bank_transfer">Bank Transfer</option>
            <option value="bank_to_bank">Bank to Bank</option>
          </select>
          <select [ngModel]="filterCardId()" (ngModelChange)="filterCardId.set($event)" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option value="">All Cards</option>
            @for (card of cards(); track card.id) {
              <option [value]="card.id">{{ card.bankName }} {{ card.cardName }}</option>
            }
          </select>
          <select [ngModel]="filterRecurring()" (ngModelChange)="filterRecurring.set($event)" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option [value]="'all'">All Transactions</option>
            <option [value]="true">Recurring Only</option>
            <option [value]="false">One-time Only</option>
          </select>
        </div>
        <button
          type="button"
          (click)="onFilter(); $event.stopPropagation()"
          class="flex items-center gap-2 px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-md transition-colors"
        >
          <lucide-angular [img]="X" [size]="16" />
          <span>Clear</span>
        </button>
      </div>
    </div>

    <!-- Transactions List -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
      @if (filteredTransactions().length === 0) {
        <div class="p-6">
          <app-empty-state
            [icon]="FileText"
            title="No transactions yet"
            message="Start tracking your income and expenses to see them here. Credit card transactions will automatically be linked to your monthly bills."
            actionLabel="Add Your First Transaction"
            (action)="onAddTransaction()"
          />
        </div>
      } @else {
        <div>
          @for (transaction of filteredTransactions(); track transaction.id) {
            <div class="transaction-item">
              <div class="transaction-info">
                <div class="transaction-description">
                  {{ transaction.description }}
                  @if (isInstallment(transaction)) {
                    <div class="inline-flex items-center gap-2 ml-2">
                      <span 
                        [ngClass]="{
                          'bg-blue-100 text-blue-800': getInstallmentStatusColor(transaction) === 'blue',
                          'bg-emerald-100 text-emerald-800': getInstallmentStatusColor(transaction) === 'emerald',
                          'bg-yellow-100 text-yellow-800': getInstallmentStatusColor(transaction) === 'yellow',
                          'bg-green-100 text-green-800': getInstallmentStatusColor(transaction) === 'green'
                        }"
                        class="inline-block px-2 py-0.5 text-xs rounded font-semibold">
                        üìÖ {{ getInstallmentProgress(transaction) }}
                        @if (transaction.isPaid) {
                          ‚úì Paid
                        } @else if (isInstallmentCompleted(transaction)) {
                          ‚úì Complete
                        }
                      </span>
                      <!-- Progress bar -->
                      <div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                        <div 
                          [ngClass]="{
                            'bg-blue-500': getInstallmentStatusColor(transaction) === 'blue',
                            'bg-emerald-500': getInstallmentStatusColor(transaction) === 'emerald',
                            'bg-yellow-500': getInstallmentStatusColor(transaction) === 'yellow',
                            'bg-green-500': getInstallmentStatusColor(transaction) === 'green'
                          }"
                          class="h-full transition-all duration-300"
                          [style.width.%]="getInstallmentProgressPercentage(transaction)">
                        </div>
                      </div>
                    </div>
                  }
                  @if (hasDebtObligation(transaction)) {
                    <span 
                      [ngClass]="{
                        'bg-red-100 text-red-800': isDebtOverdue(transaction),
                        'bg-yellow-100 text-yellow-800': !isDebtOverdue(transaction) && !transaction.debtPaid,
                        'bg-green-100 text-green-800': transaction.debtPaid
                      }"
                      class="inline-block ml-2 px-2 py-0.5 text-xs rounded font-semibold">
                      üí≥ Debt: ‚Ç±{{ transaction.debtAmount?.toLocaleString() }}
                      @if (transaction.debtPaid) {
                        ‚úì Paid
                      } @else {
                        ‚Ä¢ Due: {{ formatDebtDueDate(transaction) }}
                        @if (isDebtOverdue(transaction)) {
                          ‚ö†Ô∏è Overdue
                        }
                      }
                    </span>
                  }
                  @if (getTransactionContext(transaction)) {
                    <span class="inline-block ml-2 px-2 py-0.5 bg-amber-100 text-amber-800 text-xs rounded font-semibold">
                      {{ getTransactionContext(transaction) }}
                    </span>
                  }
                </div>
                <div class="transaction-meta">
                  {{ formatDate(transaction.date) }}
                  ‚Ä¢ {{ transaction.paymentMethod === 'card' ? getCardName(transaction.cardId) : 
                      transaction.paymentMethod === 'bank_to_bank' ? 
                        `Transfer: ${getBankAccountName(transaction.fromBankId)} ‚Üí ${getBankAccountName(transaction.toBankId)}` :
                        transaction.bankId ? getBankAccountName(transaction.bankId) :
                        transaction.paymentMethod }}
                  @if (transaction.transferFee && transaction.transferFee > 0) {
                    ‚Ä¢ Fee: ‚Ç±{{ transaction.transferFee.toLocaleString() }}
                  }
                  @if (multiProfileMode() && transaction.profileId) {
                    ‚Ä¢ {{ getProfileName(transaction.profileId) }}
                  } @else if (!multiProfileMode() && transaction.profileId !== activeProfile()?.id) {
                    ‚Ä¢ {{ getProfileName(transaction.profileId) }}'s transaction
                  }
                </div>
              </div>
              <div
                [ngClass]="['transaction-amount', transaction.type === 'income' ? 'amount-income' : 'amount-expense']">
                {{ transaction.type === 'income' ? '+' : '-' }}‚Ç±{{ transaction.amount.toLocaleString() }}
              </div>
              <div class="transaction-actions">
                <button 
                  type="button" 
                  class="icon-btn" 
                  (click)="onMarkPaid(transaction, $event)" 
                  [title]="transaction.isPaid ? 'Mark as Unpaid' : 'Mark as Paid'"
                  [ngClass]="{'text-green-600': transaction.isPaid, 'text-slate-400': !transaction.isPaid}"
                >
                  @if (transaction.isPaid) {
                    <lucide-angular [img]="CheckCircle2" [size]="18" />
                  } @else {
                    <lucide-angular [img]="Circle" [size]="18" />
                  }
                </button>
                <button type="button" class="icon-btn" (click)="onEditTransaction(transaction, $event)" title="Edit">
                  <lucide-angular [img]="Edit2" [size]="18" />
                </button>
                <button type="button" class="icon-btn" (click)="onDeleteTransaction(transaction.id, $event)" title="Delete">
                  <lucide-angular [img]="Trash2" [size]="18" />
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Help Text -->
    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start gap-3">
        <lucide-angular [img]="FileText" [size]="20" class="text-blue-600 mt-0.5" />
        <div>
          <h4 class="font-semibold text-blue-900 mb-1">Smart Transaction Linking</h4>
          <p class="text-sm text-blue-800">
            When you add a transaction with a credit card payment method, it automatically gets linked to the correct
            monthly bill based on the card's cutoff date. Transactions after the cutoff belong to the next month's bill.
          </p>
        </div>
      </div>
    </div>
  }
</div>
