<div class="max-w-7xl mx-auto px-4 py-6">
  @if (!activeProfile()) {
    <app-empty-state
      [icon]="FileText"
      title="No Profile Selected"
      message="Select a profile to view your transactions"
    />
  } @else {
    <!-- Header with Add Button -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Transactions</h1>
        <p class="text-slate-600 mt-1">Track your income and expenses</p>
      </div>
      <app-quick-action-button
        [icon]="Plus"
        label="Add Transaction"
        [variant]="showForm ? 'secondary' : 'primary'"
        (clicked)="onAddTransaction()"
      />
    </div>

    <!-- Add Transaction Form -->
    @if (showForm) {
      <div class="transaction-form">
        <h3 class="font-semibold text-slate-900 mb-4">New Transaction</h3>

        <div class="form-row">
          <div class="form-group">
            <label>Type *</label>
            <select [(ngModel)]="formData.type">
              <option value="expense">Expense</option>
              <option value="income">Income</option>
            </select>
          </div>
          <div class="form-group">
            <label>Amount *</label>
            <input type="number" [(ngModel)]="formData.amount" placeholder="0.00" step="0.01" min="0" />
          </div>
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="formData.date" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Description *</label>
            <input type="text" [(ngModel)]="formData.description" placeholder="e.g., Lunch at restaurant" />
          </div>
          <div class="form-group">
            <label>Category</label>
            <select [(ngModel)]="formData.categoryId">
              <option value="uncategorized">Uncategorized</option>
              @for (category of categories(); track category.id) {
                <option [value]="category.id">{{ category.name }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>Payment Method</label>
            <select [(ngModel)]="formData.paymentMethod">
              <option value="cash">Cash</option>
              <option value="card">Credit Card</option>
              <option value="bank_transfer">Bank Transfer</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" *ngIf="formData.paymentMethod === 'card'">
            <label>Card</label>
            <select [(ngModel)]="formData.cardId">
              <option value="">Select a card...</option>
              @for (card of cards(); track card.id) {
                <option [value]="card.id">{{ card.bankName }} {{ card.cardName }}</option>
              }
            </select>
          </div>
          <div class="form-group" *ngIf="formData.paymentMethod === 'card'" style="display: flex; align-items: flex-end; gap: 8px;">
            <label style="flex: 0 0 auto; margin-bottom: 0; display: flex; align-items: center; gap: 4px;">
              <input type="checkbox" [(ngModel)]="formData.paidByOther" />
              <span>Other person paid</span>
            </label>
          </div>
        </div>

        @if (formData.paidByOther) {
          <div class="form-row">
            <div class="form-group">
              <label>Who paid? (Select Profile)</label>
              <select [(ngModel)]="formData.paidByOtherProfileId">
                <option value="">-- Manual Entry --</option>
                @for (prof of profileService.profiles(); track prof.id) {
                  @if (prof.id !== activeProfile()?.id) {
                    <option [value]="prof.id">{{ prof.name }}</option>
                  }
                }
              </select>
            </div>
            @if (!formData.paidByOtherProfileId) {
              <div class="form-group">
                <label>Or enter name</label>
                <input type="text" [(ngModel)]="formData.paidByOtherName" placeholder="e.g., John, Mom" />
              </div>
            }
          </div>
        }

        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="formData.notes" placeholder="Optional notes..." rows="2"></textarea>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" (click)="onSubmitTransaction()">Save Transaction</button>
          <button class="btn btn-secondary" (click)="onAddTransaction()">Cancel</button>
        </div>
      </div>
    }

    <!-- Summary Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <app-metric-card
        [icon]="TrendingUp"
        label="Total Income"
        [value]="'â‚±' + summary().totalIncome.toLocaleString()"
        variant="success"
      />

      <app-metric-card
        [icon]="TrendingDown"
        label="Total Expenses"
        [value]="'â‚±' + summary().totalExpenses.toLocaleString()"
        variant="danger"
      />

      <app-metric-card
        [icon]="Wallet"
        label="Net Change"
        [value]="'â‚±' + summary().netChange.toLocaleString()"
        [variant]="summary().netChange >= 0 ? 'success' : 'danger'"
      />

      <app-metric-card
        [icon]="FileText"
        label="Transactions"
        [value]="summary().transactionCount.toString()"
        variant="info"
      />
    </div>

    <!-- Filters Bar -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm p-4 mb-6">
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="text-sm font-medium text-slate-700">Filters:</span>
          <select [(ngModel)]="filterType" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option value="all">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
          <select [(ngModel)]="filterPaymentMethod" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option value="all">All Methods</option>
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="bank_transfer">Bank Transfer</option>
          </select>
          <select [(ngModel)]="filterCardId" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option value="">All Cards</option>
            @for (card of cards(); track card.id) {
              <option [value]="card.id">{{ card.bankName }} {{ card.cardName }}</option>
            }
          </select>
          <select [(ngModel)]="filterRecurring" class="px-3 py-1.5 text-sm border border-slate-300 rounded-md">
            <option [value]="'all'">All Transactions</option>
            <option [value]="true">Recurring Only</option>
            <option [value]="false">One-time Only</option>
          </select>
        </div>
        <button
          type="button"
          (click)="onFilter()"
          class="flex items-center gap-2 px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-100 rounded-md transition-colors"
        >
          <lucide-angular [img]="X" [size]="16" />
          <span>Clear</span>
        </button>
      </div>
    </div>

    <!-- Transactions List -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm">
      @if (filteredTransactions().length === 0) {
        <div class="p-6">
          <app-empty-state
            [icon]="FileText"
            title="No transactions yet"
            message="Start tracking your income and expenses to see them here. Credit card transactions will automatically be linked to your monthly bills."
            actionLabel="Add Your First Transaction"
            (action)="onAddTransaction()"
          />
        </div>
      } @else {
        <div>
          @for (transaction of filteredTransactions(); track transaction.id) {
            <div class="transaction-item">
              <div class="transaction-info">
                <div class="transaction-description">
                  {{ transaction.description }}
                  @if (isInstallment(transaction)) {
                    <div class="inline-flex items-center gap-2 ml-2">
                      <span 
                        [ngClass]="{
                          'bg-blue-100 text-blue-800': getInstallmentStatusColor(transaction) === 'blue',
                          'bg-emerald-100 text-emerald-800': getInstallmentStatusColor(transaction) === 'emerald',
                          'bg-yellow-100 text-yellow-800': getInstallmentStatusColor(transaction) === 'yellow',
                          'bg-green-100 text-green-800': getInstallmentStatusColor(transaction) === 'green'
                        }"
                        class="inline-block px-2 py-0.5 text-xs rounded font-semibold">
                        ðŸ“… {{ getInstallmentProgress(transaction) }}
                        @if (transaction.isPaid) {
                          âœ“ Paid
                        } @else if (isInstallmentCompleted(transaction)) {
                          âœ“ Complete
                        }
                      </span>
                      <!-- Progress bar -->
                      <div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden">
                        <div 
                          [ngClass]="{
                            'bg-blue-500': getInstallmentStatusColor(transaction) === 'blue',
                            'bg-emerald-500': getInstallmentStatusColor(transaction) === 'emerald',
                            'bg-yellow-500': getInstallmentStatusColor(transaction) === 'yellow',
                            'bg-green-500': getInstallmentStatusColor(transaction) === 'green'
                          }"
                          class="h-full transition-all duration-300"
                          [style.width.%]="getInstallmentProgressPercentage(transaction)">
                        </div>
                      </div>
                    </div>
                  }
                  @if (getTransactionContext(transaction)) {
                    <span class="inline-block ml-2 px-2 py-0.5 bg-amber-100 text-amber-800 text-xs rounded font-semibold">
                      {{ getTransactionContext(transaction) }}
                    </span>
                  }
                </div>
                <div class="transaction-meta">
                  {{ formatDate(transaction.date) }}
                  â€¢ {{ transaction.paymentMethod === 'card' ? getCardName(transaction.cardId) : transaction.paymentMethod }}
                  @if (transaction.profileId !== activeProfile()?.id) {
                    â€¢ {{ getProfileName(transaction.profileId) }}'s transaction
                  }
                </div>
              </div>
              <div
                [ngClass]="['transaction-amount', transaction.type === 'income' ? 'amount-income' : 'amount-expense']">
                {{ transaction.type === 'income' ? '+' : '-' }}â‚±{{ transaction.amount.toLocaleString() }}
              </div>
              <div class="transaction-actions">
                <button class="icon-btn" title="Edit">
                  <lucide-angular [img]="Edit2" [size]="18" />
                </button>
                <button class="icon-btn" (click)="onDeleteTransaction(transaction.id)" title="Delete">
                  <lucide-angular [img]="Trash2" [size]="18" />
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- Help Text -->
    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <div class="flex items-start gap-3">
        <lucide-angular [img]="FileText" [size]="20" class="text-blue-600 mt-0.5" />
        <div>
          <h4 class="font-semibold text-blue-900 mb-1">Smart Transaction Linking</h4>
          <p class="text-sm text-blue-800">
            When you add a transaction with a credit card payment method, it automatically gets linked to the correct
            monthly bill based on the card's cutoff date. Transactions after the cutoff belong to the next month's bill.
          </p>
        </div>
      </div>
    </div>
  }
</div>
