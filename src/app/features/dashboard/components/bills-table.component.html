<div class="overflow-x-auto">
  <table class="min-w-full divide-y divide-slate-200">
    <thead class="bg-slate-50">
    <tr class="text-left text-xs font-semibold text-slate-600">
      @if (bulkSelectMode) {
        <th class="px-4 py-3 w-10">
          <input
            (change)="toggleAllCards.emit()"
            [checked]="allSelected"
            aria-label="Select all cards"
            class="w-4 h-4 text-blue-600"
            type="checkbox"
          />
        </th>
      }
      <!-- Card Column -->
      <th class="px-4 py-3">
        <button (click)="onSortClick('bankName')" class="flex items-center gap-1">
          Card
          @if (dashboardSort.key === 'bankName') {
            <span class="text-[10px] text-blue-600">
              {{ dashboardSort.direction === 'asc' ? '▲' : '▼' }}
            </span>
          }
        </button>
      </th>
      <!-- Due Date Column -->
      <th class="px-4 py-3">
        <button (click)="onSortClick('dueDate')" class="flex items-center gap-1">
          Due Date
          @if (dashboardSort.key === 'dueDate') {
            <span class="text-[10px] text-blue-600">
              {{ dashboardSort.direction === 'asc' ? '▲' : '▼' }}
            </span>
          }
        </button>
      </th>
      <!-- Statement Balance Column -->
      <th class="px-4 py-3">
        <button (click)="onSortClick('amount')" class="flex items-center gap-1">
          Statement Balance
          @if (dashboardSort.key === 'amount') {
            <span class="text-[10px] text-blue-600">
              {{ dashboardSort.direction === 'asc' ? '▲' : '▼' }}
            </span>
          }
        </button>
      </th>
      <!-- Amount Due Column -->
      <th class="px-4 py-3">Amount Due</th>
      <!-- Active Installments Column -->
      <th class="px-4 py-3">Installments</th>
      <!-- Status Column -->
      <th class="px-4 py-3">
        <button (click)="onSortClick('status')" class="flex items-center gap-1">
          Status
          @if (dashboardSort.key === 'status') {
            <span class="text-[10px] text-blue-600">
              {{ dashboardSort.direction === 'asc' ? '▲' : '▼' }}
            </span>
          }
        </button>
      </th>
      <!-- Paid Amount Column -->
      <th class="px-4 py-3">Paid Amount</th>
      <!-- Notes Column -->
      <th class="px-4 py-3">Notes</th>
      <!-- Actions Column -->
      <th class="px-4 py-3 text-right">Actions</th>
    </tr>
    </thead>
    <tbody class="divide-y divide-slate-100 bg-white">
      @for (row of sortedData; track trackRow($index, row)) {
        <tr class="text-sm hover:bg-slate-50 transition-colors">
          @if (bulkSelectMode) {
            <td class="px-4 py-3">
              <input
                (change)="toggleSelection(row)"
                [attr.aria-label]="'Select ' + row.card.bankName + ' ' + row.card.cardName"
                [checked]="isSelected(row)"
                class="w-4 h-4 text-blue-600"
                type="checkbox"
              />
            </td>
          }
          <!-- Card Info -->
          <td class="px-4 py-3">
            <div class="flex items-center gap-3">
              <div
                [style.backgroundColor]="row.card.color || '#334155'"
                class="w-10 h-7 rounded-md shadow-sm flex items-center justify-center text-[10px] text-white font-bold flex-shrink-0">
                {{ row.card.bankName.substring(0, 3).toUpperCase() }}
              </div>
              <div class="min-w-0">
                <p class="font-semibold text-slate-800 truncate">
                  {{ row.card.cardName }}
                </p>
                <p class="text-xs text-slate-500 truncate">
                  {{ row.card.bankName }}
                </p>
                @if (row.profileName) {
                  <span class="inline-flex items-center px-1.5 py-0.5 mt-1 rounded text-[10px] font-medium bg-purple-100 text-purple-700 border border-purple-200">
                    {{ row.profileName }}
                  </span>
                }
                @if (row.tags && row.tags.length > 0) {
                  <div class="flex flex-wrap gap-1 mt-1">
                    @for (tag of row.tags; track tag) {
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-amber-100 text-amber-700 border border-amber-200">
                        {{ tag }}
                      </span>
                    }
                  </div>
                }
              </div>
            </div>
          </td>
          <!-- Due Date -->
          <td class="px-4 py-3">
            @if (editingDueDate === row.card.id) {
              <div class="flex gap-2">
                <input
                  [(ngModel)]="tempDueDate"
                  class="px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  type="date"
                />
                <button
                  (click)="saveDueDate(row)"
                  class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                  title="Save">
                  ✓
                </button>
                <button
                  (click)="cancelEditDueDate()"
                  class="px-2 py-1 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400"
                  title="Cancel">
                  ✕
                </button>
              </div>
            } @else {
              <button
                (click)="startEditDueDate(row)"
                class="text-slate-700 hover:text-blue-600 hover:underline font-medium"
                title="Click to edit">
                {{ formatDate(row.displayDate) }}
              </button>
            }
          </td>
          <!-- Statement Balance (Editable) -->
          <td class="px-4 py-3">
            @if (editingBalance === row.card.id) {
              <div class="flex gap-2">
                <input
                  [(ngModel)]="tempBalance"
                  class="px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-32"
                  type="text"
                  placeholder="e.g. 5000+1000"
                />
                <button
                  (click)="saveBalance(row)"
                  class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                  title="Save">
                  ✓
                </button>
                <button
                  (click)="cancelEditBalance()"
                  class="px-2 py-1 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400"
                  title="Cancel">
                  ✕
                </button>
              </div>
            } @else {
              <div class="flex items-center gap-2">
                <button
                  (click)="startEditBalance(row)"
                  class="text-slate-700 hover:text-blue-600 hover:underline font-semibold"
                  title="Click to edit">
                  {{ rowAmount(row) }}
                </button>
                @if (row.isEstimated) {
                  <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-orange-100 text-orange-700 border border-orange-300" title="Estimated from installments">
                    EST
                  </span>
                }
              </div>
            }
          </td>
          <!-- Amount Due -->
          <td class="px-4 py-3">
            @if (editingAmountDue === row.card.id) {
              <div class="flex gap-2">
                <input
                  [(ngModel)]="tempAmountDue"
                  class="px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-32"
                  type="text"
                  placeholder="e.g. 5000+1000"
                />
                <button
                  (click)="saveAmountDue(row)"
                  class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                  title="Save">
                  ✓
                </button>
                <button
                  (click)="cancelEditAmountDue()"
                  class="px-2 py-1 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400"
                  title="Cancel">
                  ✕
                </button>
              </div>
            } @else {
              <button
                (click)="startEditAmountDue(row)"
                class="text-slate-700 hover:text-blue-600 hover:underline font-semibold"
                title="Click to edit">
                {{ rowAmountDue(row) }}
              </button>
            }
          </td>
          <!-- Active Installments -->
          <td class="px-4 py-3">
            @if (getActiveInstallmentCount(row) > 0) {
              <div class="flex flex-col gap-1">
                @for (installment of row.activeInstallments; track installment.id) {
                  <div class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-700 border border-blue-300 gap-1">
                    <span class="font-semibold">{{ installment.name }}</span>
                    <span class="text-blue-600">{{ utils.formatCurrency(installment.monthlyAmortization) }}</span>
                    <span class="text-blue-600">{{ utils.getInstallmentStatus(installment, row.displayDate).currentTerm }} / {{ installment.terms }}</span>
                  </div>
                }
              </div>
            } @else {
              <span class="text-xs text-slate-500">—</span>
            }
          </td>
          <!-- Status -->
          <td class="px-4 py-3">
            <div class="flex justify-center gap-2">
              <button
                (click)="toggleBilledStatus(row)"
                [class]="(row.stmt?.isUnbilled === false) ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'"
                class="px-2 py-1 rounded text-xs font-semibold hover:shadow-md transition-shadow"
                [title]="row.isEstimated ? 'Toggle billed/unbilled status (using estimated amount)' : 'Toggle billed/unbilled status'">
                {{ row.stmt?.isUnbilled === false ? 'Billed' : 'Unbilled' }}
              </button>
              <button
                (click)="toggleStatus(row)"
                [class]="row.isPaid ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'"
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-xs font-semibold hover:shadow-md transition-shadow"
                title="Toggle paid/unpaid status">
                <lucide-icon [img]="row.isPaid ? CheckCircle2 : Circle" class="w-4 h-4"></lucide-icon>
                {{ row.isPaid ? 'Paid' : 'Unpaid' }}
              </button>
            </div>
          </td>
          <!-- Paid Amount -->
          <td class="px-4 py-3">
            @if (editingPaidAmount === row.card.id) {
              <div class="flex gap-2">
                <input
                  [(ngModel)]="tempPaidAmount"
                  class="px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-32"
                  type="text"
                  placeholder="e.g. 5000+1000"
                />
                <button
                  (click)="savePaidAmount(row)"
                  class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                  title="Save">
                  ✓
                </button>
                <button
                  (click)="cancelEditPaidAmount()"
                  class="px-2 py-1 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400"
                  title="Cancel">
                  ✕
                </button>
              </div>
            } @else {
              <div class="flex flex-col gap-1.5">
                @if (row.stmt && row.stmt.payments && row.stmt.payments.length > 0) {
                  <div class="flex flex-col gap-1">
                    @for (payment of row.stmt.payments; track trackPayment($index)) {
                      <div class="flex items-center gap-2 text-xs bg-green-50 border border-green-200 rounded px-2 py-1">
                        <span class="font-semibold text-green-700">{{ utils.formatCurrency(payment.amount) }}</span>
                        @if (editingPaymentDate === row.card.id + '-' + $index) {
                          <input
                            [(ngModel)]="tempPaymentDate"
                            class="px-1 py-0.5 border border-slate-300 rounded text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 w-24"
                            type="date"
                          />
                          <button
                            (click)="savePaymentDate(row, $index)"
                            class="px-1 py-0.5 bg-green-600 text-white text-[10px] rounded hover:bg-green-700"
                            title="Save">
                            ✓
                          </button>
                          <button
                            (click)="cancelEditPaymentDate()"
                            class="px-1 py-0.5 bg-slate-300 text-slate-700 text-[10px] rounded hover:bg-slate-400"
                            title="Cancel">
                            ✕
                          </button>
                        } @else {
                          <button
                            (click)="startEditPaymentDate(row, $index, payment.date)"
                            class="text-slate-500 hover:text-blue-600 hover:underline"
                            title="Click to edit payment date">
                            {{ utils.formatDate(payment.date, 'MMM dd') }}
                          </button>
                        }
                        <button
                          (click)="removePayment(row, $index)"
                          class="ml-auto text-red-600 hover:text-red-800 hover:bg-red-100 rounded p-0.5"
                          title="Remove payment">
                          ✕
                        </button>
                      </div>
                    }
                  </div>
                }
                <button
                  (click)="startEditPaidAmount(row)"
                  class="text-blue-600 hover:text-blue-800 text-xs font-medium hover:underline text-left"
                  title="Add payment">
                  + Add Payment
                </button>
                @if ((row.paidAmount ?? 0) > 0 || ((row.paidAmount ?? 0) < (row.amountDue ?? row.displayAmount))) {
                  <div class="w-full bg-slate-200 rounded-full h-1.5 mt-1">
                    <div
                      class="h-1.5 rounded-full transition-all"
                      [class]="(row.paidAmount ?? 0) >= (row.amountDue ?? row.displayAmount) ? 'bg-green-500' : 'bg-blue-500'"
                      [style.width.%]="((row.paidAmount ?? 0) / (row.amountDue ?? row.displayAmount)) * 100">
                    </div>
                  </div>
                  <div class="text-xs text-slate-600">
                    Remaining: <span class="font-semibold text-slate-700">{{ rowRemainingAmount(row) }}</span>
                  </div>
                }
              </div>
            }
          </td>
          <!-- Notes -->
          <td class="px-4 py-3">
            @if (editingNotes === row.card.id) {
              <div class="flex gap-2">
                <textarea
                  [(ngModel)]="tempNotes"
                  class="px-2 py-1 border border-slate-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 min-h-[60px] resize-y"
                  placeholder="Add notes..."
                  rows="3"></textarea>
                <div class="flex flex-col gap-1">
                  <button
                    (click)="saveNotes(row)"
                    class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700"
                    title="Save">
                    ✓
                  </button>
                  <button
                    (click)="cancelEditNotes()"
                    class="px-2 py-1 bg-slate-300 text-slate-700 text-xs rounded hover:bg-slate-400"
                    title="Cancel">
                    ✕
                  </button>
                </div>
              </div>
            } @else {
              <button
                (click)="startEditNotes(row)"
                class="text-slate-700 hover:text-blue-600 hover:underline text-sm text-left whitespace-pre-wrap max-w-[200px] block"
                title="Click to edit">
                {{ row.notes || '—' }}
              </button>
            }
          </td>
          <!-- Actions -->
          <td class="px-4 py-3 text-right">
            <div class="flex justify-end gap-2">
              <button
                (click)="copyRow(row)"
                [attr.aria-label]="'Copy info for ' + row.card.bankName + ' ' + row.card.cardName"
                [disabled]="isCopying === rowId(row)"
                class="text-blue-600 hover:text-blue-800 hover:bg-blue-50 p-1 rounded transition-colors"
                title="Copy card info">
                <lucide-icon [img]="Copy" class="w-4 h-4"></lucide-icon>
              </button>
              <button
                class="text-slate-600 hover:text-slate-800 hover:bg-slate-100 p-1 rounded transition-colors"
                title="More options">
                <lucide-icon [img]="MoreVertical" class="w-4 h-4"></lucide-icon>
              </button>
            </div>
          </td>
        </tr>
      }
      @if (sortedData.length === 0) {
        <tr>
          <td [attr.colspan]="visibleColumnsCount" class="text-center text-slate-500 text-sm py-6">
            No bills for this month.
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>
